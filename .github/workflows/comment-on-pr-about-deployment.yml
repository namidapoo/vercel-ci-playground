name: Comment on PR about Deployment

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  comment-deployment-status:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      actions: read
    steps:
      - name: Check deployment status and comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          COMMIT_SHA="${{ github.event.pull_request.head.sha }}"
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡ŒçŠ¶æ³ã‚’ç¢ºèª
          WORKFLOW_RUN=$(gh api repos/${{ github.repository }}/actions/workflows/vercel-preview-deploy.yml/runs \
            --jq ".workflow_runs[] | select(.head_sha == \"$COMMIT_SHA\") | {id, status, conclusion}" \
            | head -1 | tr -d '\n')
          
          echo "Workflow run data: $WORKFLOW_RUN"
          
          if [ -n "$WORKFLOW_RUN" ] && [ "$WORKFLOW_RUN" != "null" ] && [ "$WORKFLOW_RUN" != "" ]; then
            STATUS=$(echo "$WORKFLOW_RUN" | jq -r '.status // "unknown"')
            CONCLUSION=$(echo "$WORKFLOW_RUN" | jq -r '.conclusion // "unknown"')
            RUN_ID=$(echo "$WORKFLOW_RUN" | jq -r '.id // ""')
            
            echo "Workflow status: $STATUS, conclusion: $CONCLUSION"
            
            if [ "$STATUS" = "completed" ] && [ "$CONCLUSION" = "success" ]; then
              # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸæ¸ˆã¿ - ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å‡ºåŠ›ã‹ã‚‰Preview URLã‚’å–å¾—
              DEPLOY_OUTPUT=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/jobs --jq '.jobs[0].steps[] | select(.name | contains("Deploy Project Artifacts")) | .conclusion')
              
              if [ "$DEPLOY_OUTPUT" = "success" ]; then
                # ãƒ­ã‚°ã‹ã‚‰Preview URLã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
                LOGS=$(gh api repos/${{ github.repository }}/actions/runs/$RUN_ID/logs)
                
                COMMENT_BODY="<!-- vercel-preview-comment:$COMMIT_SHA -->
          ## ğŸš€ Preview Deployment
          
          âœ… **Status**: Ready ([Inspect](https://vercel.com))
          ğŸ”— **Preview**: [Visit Preview](https://vercel.com/${{ github.repository }})
          ğŸ“ **Branch**: \`$BRANCH_NAME\`
          ğŸ“… **Updated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          "
              else
                COMMENT_BODY="<!-- vercel-preview-comment:$COMMIT_SHA -->
          ## ğŸš€ Preview Deployment
          
          âŒ **Status**: Failed
          ğŸ“ **Branch**: \`$BRANCH_NAME\`
          ğŸ“… **Updated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          "
              fi
            else
              # ãƒ‡ãƒ—ãƒ­ã‚¤ä¸­ã¾ãŸã¯ã¾ã é–‹å§‹ã•ã‚Œã¦ã„ãªã„
              COMMENT_BODY="<!-- vercel-preview-comment:$COMMIT_SHA -->
          ## ğŸš€ Preview Deployment
          
          â³ **Status**: In Progress
          ğŸ“ **Branch**: \`$BRANCH_NAME\`
          ğŸ“… **Updated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          "
            fi
          else
            # ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒã¾ã é–‹å§‹ã•ã‚Œã¦ã„ãªã„
            COMMENT_BODY="<!-- vercel-preview-comment:$COMMIT_SHA -->
          ## ğŸš€ Preview Deployment
          
          â³ **Status**: Starting
          ğŸ“ **Branch**: \`$BRANCH_NAME\`
          ğŸ“… **Updated**: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          "
          fi
          
          # ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿/æ›´æ–°
          COMMENT_ID=$(gh pr comment list $PR_NUMBER --json body,id --jq ".[] | select(.body | contains(\"vercel-preview-comment:$COMMIT_SHA\")) | .id")
          
          if [ -z "$COMMENT_ID" ]; then
            # æ–°è¦ã‚³ãƒ¡ãƒ³ãƒˆä½œæˆ
            gh pr comment $PR_NUMBER --body "$COMMENT_BODY"
            echo "Created new comment on PR #$PR_NUMBER"
          else
            # æ—¢å­˜ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°
            gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID --method PATCH --field body="$COMMENT_BODY"
            echo "Updated existing comment on PR #$PR_NUMBER"
          fi